import ze from '@fastify/cors';
import Me from '@fastify/helmet';
import Ge from '@fastify/jwt';
import $e from '@fastify/redis';
import Qe from '@fastify/swagger';
import Ze from '@fastify/websocket';
import Ye from '@scalar/fastify-api-reference';
import Xe from 'fastify';
import { validatorCompiler, serializerCompiler } from 'fastify-type-provider-zod';
import { DefaultLogger, WebsocketClient } from 'bybit-api';
import ie from 'fastify-plugin';
import 'dotenv/config';
import a, { ZodError } from 'zod';
import { WalletContractV1R1, WalletContractV1R2, WalletContractV1R3, WalletContractV2R1, WalletContractV2R2, WalletContractV3R1, WalletContractV3R2, WalletContractV4, Cell, contractAddress, TonClient, Address, internal, beginCell, fromNano, TonClient4, loadStateInit } from '@ton/ton';
import { Buffer } from 'buffer';
import { mnemonicToPrivateKey, sha256 } from '@ton/crypto';
import z from 'tweetnacl';
import { DataStream, storeDSTPublishCandlestick } from 'nenuma-contracts';

var se=async t=>{({...DefaultLogger,silly:(...r)=>console.log("silly",...r)});let n=new WebsocketClient({market:"v5"});t.addHook("onClose",async()=>{n.closeAll();}),t.decorate("bybit",{ws:n});},A=ie(se);var I=(r=>(r.development="development",r.test="test",r.production="production",r))(I||{}),ce=a.object({NODE_ENV:a.nativeEnum(I),LOG_LEVEL:a.string(),API_HOST:a.string(),API_PORT:a.string(),ALLOWED_ORIGINS:a.string(),REDIS_URI:a.string(),REDIS_TOKEN:a.string(),COOKIE_SECRET:a.string(),JWT_SECRET:a.string(),RPC_PROVIDER_API_KEY:a.string()}),le=async t=>{let e=ce.safeParse(process.env);if(!e.success)throw new Error(".env file validation failed - "+JSON.stringify(e.error,null,2));t.decorate("config",e.data);},P=ie(le);var k=(n=>(n.MAINNET="-239",n.TESTNET="-3",n))(k||{}),N=(s=>(s.BTCUSDT="kline.1.BTCUSDT",s.ETHUSDT="kline.1.ETHUSDT",s.BNBUSDT="kline.1.BNBUSDT",s.SOLUSDT="kline.1.SOLUSDT",s.TONUSDT="kline.1.TONUSDT",s))(N||{});var y=a.enum(["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","TONUSDT"]),T=a.object({start:a.number(),end:a.number(),interval:a.string(),open:a.string(),close:a.string(),high:a.string(),low:a.string(),volume:a.string(),turnover:a.string(),confirm:a.boolean(),timestamp:a.number()});a.object({topic:a.string(),data:a.array(T),ts:a.number(),type:a.string(),wsKey:a.string()});var pe=a.object({open:a.number(),close:a.number(),high:a.number(),low:a.number(),time:a.number()});a.array(pe);var v=a.object({op:a.enum(["subscribe"]),args:a.array(y)});var C=class t{static create(e){return e==="-239"&&(e=new TonClient4({endpoint:"https://mainnet-v4.tonhubapi.com"})),e==="-3"&&(e=new TonClient4({endpoint:"https://testnet-v4.tonhubapi.com"})),new t(e)}client;constructor(e){this.client=e;}async getWalletPublicKey(e){let n=await this.client.getLastBlock(),r=await this.client.runMethod(n.last.seqno,Address.parse(e),"get_public_key",[]);return Buffer.from(r.reader.readBigNumber().toString(16).padStart(64,"0"),"hex")}async getAccountInfo(e){let n=await this.client.getLastBlock();return await this.client.getAccount(n.last.seqno,Address.parse(e))}};var O=class{static create(e){let n=WalletContractV4.create(e),{data:r}=n.init,o=Cell.fromBoc(Buffer.from("B5EE9C72410215010002F5000114FF00F4A413F4BCF2C80B010201200203020148040504F8F28308D71820D31FD31FD31F02F823BBF263ED44D0D31FD31FD3FFF404D15143BAF2A15151BAF2A205F901541064F910F2A3F80024A4C8CB1F5240CB1F5230CBFF5210F400C9ED54F80F01D30721C0009F6C519320D74A96D307D402FB00E830E021C001E30021C002E30001C0039130E30D03A4C8CB1F12CB1FCBFF1112131403EED001D0D3030171B0915BE021D749C120915BE001D31F218210706C7567BD228210626C6E63BDB022821064737472BDB0925F03E002FA403020FA4401C8CA07CBFFC9D0ED44D0810140D721F404305C810108F40A6FA131B3925F05E004D33FC8258210706C7567BA9131E30D248210626C6E63BAE30004060708020120090A005001FA00F404308210706C7567831EB17080185005CB0527CF165003FA02F40012CB69CB1F5210CB3F0052F8276F228210626C6E63831EB17080185005CB0527CF1624FA0214CB6A13CB1F5230CB3F01FA02F4000092821064737472BA8E3504810108F45930ED44D0810140D720C801CF16F400C9ED54821064737472831EB17080185004CB0558CF1622FA0212CB6ACB1FCB3F9410345F04E2C98040FB000201200B0C0059BD242B6F6A2684080A06B90FA0218470D4080847A4937D29910CE6903E9FF9837812801B7810148987159F31840201580D0E0011B8C97ED44D0D70B1F8003DB29DFB513420405035C87D010C00B23281F2FFF274006040423D029BE84C600201200F100019ADCE76A26840206B90EB85FFC00019AF1DF6A26840106B90EB858FC0006ED207FA00D4D422F90005C8CA0715CBFFC9D077748018C8CB05CB0222CF165005FA0214CB6B12CCCCC971FB00C84014810108F451F2A702006C810108D718C8542025810108F451F2A782106E6F746570748018C8CB05CB025004CF16821005F5E100FA0213CB6A12CB1FC971FB00020072810108D718305202810108F459F2A7F82582106473747270748018C8CB05CB025005CF16821005F5E100FA0214CB6A13CB1F12CB3FC973FB00000AF400C9ED5446A9F34F","hex"))[0];return n.init={data:r,code:o},n.address=contractAddress(e.workchain,n.init),n}},be=[{contract:WalletContractV1R1,loadData:K},{contract:WalletContractV1R2,loadData:K},{contract:WalletContractV1R3,loadData:K},{contract:WalletContractV2R1,loadData:L},{contract:WalletContractV2R2,loadData:L},{contract:WalletContractV3R1,loadData:q},{contract:WalletContractV3R2,loadData:q},{contract:O,loadData:W},{contract:WalletContractV4,loadData:W}].map(({contract:t,loadData:e})=>({contract:t,loadData:e,wallet:t.create({workchain:0,publicKey:Buffer.alloc(32)})}));function K(t){let e=t.loadUint(32),n=t.loadBuffer(32);return {seqno:e,publicKey:n}}function L(t){let e=t.loadUint(32),n=t.loadBuffer(32);return {seqno:e,publicKey:n}}function q(t){let e=t.loadUint(32),n=t.loadUint(32),r=t.loadBuffer(32);return {seqno:e,publicKey:r,walletId:n}}function W(t){let e=t.loadUint(32),n=t.loadUint(32),r=t.loadBuffer(32),o=t.loadMaybeRef();return {seqno:e,publicKey:r,walletId:n,plugins:o}}function j(t){if(!t.code||!t.data)return null;for(let{wallet:e,loadData:n}of be)try{if(e.init.code.equals(t.code))return n(t.data.beginParse()).publicKey}catch{}return null}var Ee="ton-proof-item-v2/",Ae="ton-connect",Pe=15*60,h=class{generatePayload(){return Buffer.from(z.randomBytes(32)).toString("hex")}async checkProof(e,n){try{let r=loadStateInit(Cell.fromBase64(e.proof.state_init).beginParse()),o=j(r)??await n(e.address);if(!o)return !1;let s=Buffer.from(e.public_key,"hex");if(!o.equals(s))return !1;let p=Address.parse(e.address),f=contractAddress(p.workChain,r);if(!f.equals(p)||Math.floor(Date.now()/1e3)-Pe>e.proof.timestamp)return !1;let m={workchain:f.workChain,address:f.hash,domain:{lengthBytes:e.proof.domain.lengthBytes,value:e.proof.domain.value},signature:Buffer.from(e.proof.signature,"base64"),payload:e.proof.payload,stateInit:e.proof.state_init,timestamp:e.proof.timestamp},S=Buffer.alloc(4);S.writeUInt32BE(m.workchain,0);let D=Buffer.alloc(8);D.writeBigUInt64LE(BigInt(m.timestamp),0);let F=Buffer.alloc(4);F.writeUInt32LE(m.domain.lengthBytes,0);let w=Buffer.concat([Buffer.from(Ee),S,m.address,F,Buffer.from(m.domain.value),D,Buffer.from(m.payload)]),x=Buffer.from(await sha256(w)),E=Buffer.concat([Buffer.from([255,255]),Buffer.from(Ae),x]),oe=Buffer.from(await sha256(E));return z.sign.detached.verify(oe,m.signature,o)}catch{return !1}}};var g=class{static async parseKlineTopic(e,n){let r=n.pipeline();r.lrange(e[0],0,-1),r.get(e[1]);let o=await r.exec();if(!o)throw new Error("Failed to fetch data from Redis");let s=(o[0]?.[1]).map(m=>JSON.parse(m)),p=JSON.parse(o[1]?.[1]),f=a.array(T).safeParse(s),i=T.safeParse(p);if(!f.success||!i.success)throw f.error||i.error;return {confirmedCandlesticks:f.data,latestCandlestick:i.data}}};var Oe=(t,e)=>e.topic===t,M=async(t,e)=>{let {redis:n}=t.server,{topic:r}=t.params,o=[],s=null;switch(r){case y.Enum.BTCUSDT:try{let i=await g.parseKlineTopic(["kline:BTC:24h","kline:BTC:1m"],n);o=i.confirmedCandlesticks,s=i.latestCandlestick;}catch(i){i instanceof ZodError&&(i=i);}break;case y.Enum.ETHUSDT:try{let i=await g.parseKlineTopic(["kline:ETH:24h","kline:ETH:1m"],n);o=i.confirmedCandlesticks,s=i.latestCandlestick;}catch(i){i instanceof ZodError&&(i=i);}break;case y.Enum.TONUSDT:try{let i=await g.parseKlineTopic(["kline:TON:24h","kline:TON:1m"],n);o=i.confirmedCandlesticks,s=i.latestCandlestick;}catch(i){i instanceof ZodError&&(i=i);}break;case y.Enum.SOLUSDT:try{let i=await g.parseKlineTopic(["kline:SOL:24h","kline:SOL:1m"],n);o=i.confirmedCandlesticks,s=i.latestCandlestick;}catch(i){i instanceof ZodError&&(i=i);}break;case y.Enum.BNBUSDT:try{let i=await g.parseKlineTopic(["kline:BNB:24h","kline:BNB:1m"],n);o=i.confirmedCandlesticks,s=i.latestCandlestick;}catch(i){i instanceof ZodError&&(i=i);}break}if(o.length<=0||!s)return e.status(404).send({error:"Not found. Candlesticks data is empty."});let f=[];for(let i of o)f.push({open:Number(i.open),close:Number(i.close),high:Number(i.high),low:Number(i.low),time:i.timestamp/1e3});return e.code(200).send({list:f,latest:{open:Number(s?.open),close:Number(s?.close),high:Number(s?.high),low:Number(s?.low),time:s.end/1e3}})},G=async(t,e)=>{let{bybit:n}=e.server;t.on("message",async r=>{try{let s=v.parse(JSON.parse(r.toString())).args;n.ws.on("update",p=>Re(t,p,s));}catch(o){if(o instanceof ZodError){t.send(JSON.stringify({error:o.format()}));return}o instanceof Error&&t.send(JSON.stringify({error:"Invalid JSON payload"}));}});},Re=(t,e,n)=>{for(let r of n)if(Oe(`kline.1.${r}`,e))for(let o of e.data)t.send(JSON.stringify({topic:r,data:{high:Number(o.high),low:Number(o.low),open:Number(o.open),close:Number(o.close),time:Math.ceil(o.end/1e3)}}));};var Ve=async t=>{let{redis:e,bybit:n}=t;n.ws.subscribeV5(Object.values(N),"spot"),n.ws.on("update",async r=>{switch(r.topic){case"kline.1.BTCUSDT":for(let o of r.data)if(o.confirm){e.pipeline().rpush("kline:BTC:24h",JSON.stringify(o)).ltrim("kline:BTC:24h",0,1439).exec();try{let s=new TonClient({endpoint:"https://testnet.toncenter.com/api/v2/jsonRPC",apiKey:"9e557d76a302f31496f5fe90a62cb4f90ed4ef97a0e8aa08d310080f30f6263c"}),f=await s.open(DataStream.fromAddress(Address.parse("kQDZnFY0yew3AcB0pk0H0CL5L2kclQXH0VHO_cWyfdOQ0SEp"))).getBatches(),i=!1;for(let[x,E]of f)E.subscriptionsCount>0?i=!1:i=!0;if(i)return;let m=await mnemonicToPrivateKey(["squirrel","focus","excite","kangaroo","quit","post","milk","twelve","sketch","cupboard","sunny","similar","toe","orient","soccer","uncle","forward","fame","bundle","vanish","crisp","slush","coast","hair"]),D=WalletContractV4.create({workchain:0,publicKey:m.publicKey}),F=s.open(D),w=await F.getSeqno();await F.sendTransfer({seqno:w,secretKey:m.secretKey,messages:[internal({value:"5",to:"kQDZnFY0yew3AcB0pk0H0CL5L2kclQXH0VHO_cWyfdOQ0SEp",body:beginCell().store(storeDSTPublishCandlestick({$$type:"DSTPublishCandlestick",queryId:777n,candlestick:{$$type:"Candlestick",open:BigInt(o.open.split(".").join("")),high:BigInt(o.high.split(".").join("")),low:BigInt(o.low.split(".").join("")),close:BigInt(o.close.split(".").join("")),start:BigInt(o.start),end:BigInt(o.end)}})).endCell()})]});}catch{}}else e.set("kline:BTC:1m",JSON.stringify(o));break;case"kline.1.ETHUSDT":for(let o of r.data)o.confirm?e.pipeline().rpush("kline:ETH:24h",JSON.stringify(o)).ltrim("kline:ETH:24h",0,1439).exec():e.set("kline:ETH:1m",JSON.stringify(o));break;case"kline.1.BNBUSDT":for(let o of r.data)o.confirm?e.pipeline().rpush("kline:BNB:24h",JSON.stringify(o)).ltrim("kline:BNB:24h",0,1439).exec():e.set("kline:BNB:1m",JSON.stringify(o));break;case"kline.1.SOLUSDT":for(let o of r.data)o.confirm?e.pipeline().rpush("kline:SOL:24h",JSON.stringify(o)).ltrim("kline:SOL:24h",0,1439).exec():e.set("kline:SOL:1m",JSON.stringify(o));break;case"kline.1.TONUSDT":for(let o of r.data)o.confirm?e.pipeline().rpush("kline:TON:24h",JSON.stringify(o)).ltrim("kline:TON:24h",0,1439).exec():e.set("kline:TON:1m",JSON.stringify(o));break}}),t.get("/kline/:topic",{schema:{params:a.object({topic:y}),querystring:a.object({token:a.string().optional()}).optional()},preHandler:async(r,o)=>{try{await r.jwtVerify();}catch(s){o.send(s);}}},M),t.get("/kline",{websocket:!0,preHandler:async(r,o)=>{try{if(r.query&&typeof r.query=="object"&&"token"in r.query){let{token:s}=r.query;r.headers.authorization=`Bearer ${s}`;}await r.jwtVerify();}catch(s){o.send(s);}}},G);},$=Ve;var Q=a.object({address:a.string(),network:a.nativeEnum(k),public_key:a.string(),proof:a.object({timestamp:a.number(),domain:a.object({lengthBytes:a.number(),value:a.string()}),payload:a.string(),signature:a.string(),state_init:a.string()})});async function Z(t,e){try{let n=C.create("-3");if(!await new h().checkProof(t.body,f=>n.getWalletPublicKey(f)))return e.code(400).send({message:"Invalid proof"});if(!t.server.jwt.verify(t.body.proof.payload).toString())return e.code(400).send({message:"Invalid token"});let p=await e.jwtSign({address:t.body.address,network:t.body.network,name:"Vladimir Starkov",email:"test@gmail.com"},{expiresIn:"180d"});return e.code(200).send({message:"Proof is valid",token:p})}catch(n){return console.error(n),e.code(400).send({message:"Invalid request",error:n})}}async function Y(t,e){try{let r=new h().generatePayload(),o=await e.jwtSign({payload:r},{expiresIn:"15m"});return e.code(200).send({proofToken:o})}catch(n){return console.error(n),e.code(400).send({message:"Invalid request",error:n})}}async function X(t,e){try{let{address:n,network:r}=t.user,o=C.create(r),{account:s}=await o.getAccountInfo(n);return e.code(200).send({address:n,balance:fromNano(s.balance.coins)})}catch(n){return console.error(n),e.code(400).send({message:"Invalid request",error:n})}}var je=async t=>{t.post("/check-proof",{schema:{body:Q}},Z),t.post("/generate-proof-payload",{},Y),t.get("/account-info",{preHandler:async(e,n)=>{try{await e.jwtVerify();}catch(r){n.send(r);}}},X);},ee=je;var Je=async t=>{await t.register($),await t.register(ee);},te=Je;var c=Xe({logger:{level:process.env.LOG_LEVEL}}).withTypeProvider();c.setValidatorCompiler(validatorCompiler);c.setSerializerCompiler(serializerCompiler);await c.register(P);await c.register(ze,{origin:"*"});await c.register(Me);await c.register(Ge,{secret:c.config.JWT_SECRET});await c.register(Qe,{openapi:{openapi:"3.0.0",info:{title:"Test swagger",description:"Testing the Fastify swagger API",version:"0.1.0"},servers:[{url:"http://localhost:3000",description:"Development server"}],tags:[{name:"user",description:"User related end-points"},{name:"code",description:"Code related end-points"}],components:{securitySchemes:{apiKey:{type:"apiKey",name:"apiKey",in:"header"}}},externalDocs:{url:"https://swagger.io",description:"Find more info here"}}});await c.register(Ye,{routePrefix:"/reference",configuration:{spec:{content:()=>c.swagger()}}});await c.register(Ze,{options:{maxPayload:1048576}});await c.register($e,{url:c.config.REDIS_URI});await c.register(A);c.get("/",(t,e)=>e.code(418).send({message:"I am a teapot"}));await c.register(te);await c.ready();var b=c;process.on("unhandledRejection",t=>{console.error(t),process.exit(1);});var ot=+b.config.API_PORT,nt=b.config.API_HOST;await b.listen({host:nt,port:ot});for(let t of ["SIGINT","SIGTERM"])process.on(t,()=>b.close().then(e=>{console.log(`close application on ${t}`),process.exit(e?1:0);}));
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map